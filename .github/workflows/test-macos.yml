name: Rust

on:
  push:
    branches: ["feature/macos_arm64"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: macos-latest
    steps:
    - name: Checkout sources
      uses: actions/checkout@v3
      with:
        submodules: 'true'
    - name: Install Dependencies
      run: brew update && brew upgrade && brew install autoconf automake libtool pkg-config jansson libmagic openssl python@3.12
    - name: Build Yara
      run: cd yari-sys/yara && ./bootstrap.sh && CFLAGS="-fPIC -I/opt/homebrew/include" LDFLAGS="-L/opt/homebrew/lib $LDFLAGS" LIBRARY_PATH="/opt/homebrew/lib:$LIBRARY_PATH" ./configure --enable-debug --disable-shared --enable-static --enable-cuckoo --enable-magic --enable-dotnet --with-crypto && make
    - name: Build Yari (yari-sys)
      run: CFLAGS="-I/opt/homebrew/include" LDFLAGS="-L/opt/homebrew/lib $LDFLAGS" LIBRARY_PATH="/opt/homebrew/lib:$LIBRARY_PATH" cargo build --verbose
    - name: Run Rust tests
      run: CFLAGS="-I/opt/homebrew/include" LDFLAGS="-L/opt/homebrew/lib $LDFLAGS" LIBRARY_PATH="/opt/homebrew/lib:$LIBRARY_PATH" cargo test --verbose
